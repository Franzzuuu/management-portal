// src/lib/pdf-exporter.js
import { jsPDF } from 'jspdf';
import { DateUtils, ColumnMappings } from './export-utils.js';

export class PDFExporter {
    constructor(reportType, options = {}) {
        this.reportType = reportType;
        this.options = options;
        
        try {
            // Initialize jsPDF - simplified without autoTable
            this.doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });
            
            this.currentY = 20;
            this.pageHeight = 280;
            this.margin = 15;
        } catch (error) {
            console.error('jsPDF initialization error:', error);
            throw new Error('Failed to initialize PDF generator: ' + error.message);
        }
    }

    // Add header with logo and title
    addHeader() {
        const doc = this.doc;

        // Title with black color
        doc.setFontSize(20);
        doc.setTextColor(0, 0, 0); // Black color
        doc.text('RFID Vehicle Management System', this.margin, this.currentY);

        this.currentY += 10;

        // Subtitle
        doc.setFontSize(14);
        doc.setTextColor(0, 0, 0);
        doc.text(`${this.reportType.toUpperCase()} Report`, this.margin, this.currentY);

        this.currentY += 15;
    }

    // Add report metadata
    addMetadata() {
        const doc = this.doc;

        doc.setFontSize(12);
        doc.setTextColor(53, 94, 59); // ISMiS green
        doc.text('Report Information', this.margin, this.currentY);

        this.currentY += 8;

        const metadata = [
            ['Generated:', new Date().toLocaleString()],
            ['Report Type:', this.reportType.toUpperCase()],
            ['Generated By:', this.options.user || 'System'],
            ['Date Range:', this.options.dateRange || 'All Time']
        ];

        doc.setFontSize(10);
        doc.setTextColor(0, 0, 0);

        metadata.forEach(([key, value]) => {
            doc.text(`${key} ${value}`, this.margin + 5, this.currentY);
            this.currentY += 6;
        });

        this.currentY += 10;
    }

    // Add summary statistics
    addSummary(summaryData) {
        if (!summaryData || Object.keys(summaryData).length === 0) return;

        const doc = this.doc;

        doc.setFontSize(14);
        doc.setTextColor(53, 94, 59);
        doc.text('Summary Statistics', this.margin, this.currentY);

        this.currentY += 10;

        // Create summary table with basic table rendering
        const tableData = Object.entries(summaryData).map(([key, value]) => [
            key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
            typeof value === 'number' ? value.toLocaleString() : String(value)
        ]);

        this.drawBasicTable(['Metric', 'Value'], tableData, {
            headerColor: [53, 94, 59], // huntergreen
            startY: this.currentY
        });

        this.currentY += (tableData.length + 2) * 8 + 10;
    }

    // Add data table
    addDataTable(headers, data, options = {}) {
        if (!data || data.length === 0) {
            this.doc.text('No data available', this.margin, this.currentY);
            this.currentY += 10;
            return;
        }

        const doc = this.doc;
        const maxRows = options.maxRows || 50;
        const displayData = data.slice(0, maxRows);

        // Check if we need a new page
        if (this.currentY > this.pageHeight - 50) {
            this.doc.addPage();
            this.currentY = 20;
        }

        this.drawBasicTable(headers, displayData, {
            headerColor: [53, 94, 59], // huntergreen
            startY: this.currentY,
            striped: true
        });

        this.currentY += (displayData.length + 2) * 6 + 5;

        // Add note if data was truncated
        if (data.length > maxRows) {
            doc.setFontSize(9);
            doc.setTextColor(102, 102, 102);
            doc.text(`Note: Showing first ${maxRows} of ${data.length} records. Download full dataset for complete data.`,
                this.margin, this.currentY);
            this.currentY += 10;
        }
    }

    // Helper method to draw basic tables without autoTable dependency
    drawBasicTable(headers, data, options = {}) {
        const doc = this.doc;
        const { headerColor = [200, 200, 200], startY = this.currentY, striped = false } = options;
        
        const colWidth = 180 / headers.length;
        const rowHeight = 6;
        let currentY = startY;

        // Draw header
        doc.setFillColor(headerColor[0], headerColor[1], headerColor[2]);
        doc.rect(this.margin, currentY, 180, rowHeight, 'F');
        
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        headers.forEach((header, i) => {
            doc.text(String(header), this.margin + 2 + (i * colWidth), currentY + 4);
        });

        currentY += rowHeight;

        // Draw data rows
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(8);
        data.forEach((row, rowIndex) => {
            // Alternate row colors if striped
            if (striped && rowIndex % 2 === 0) {
                doc.setFillColor(249, 249, 249);
                doc.rect(this.margin, currentY, 180, rowHeight, 'F');
            }

            row.forEach((cell, i) => {
                const cellText = String(cell || '');
                const maxWidth = colWidth - 4;
                
                // Truncate text if too long
                let displayText = cellText;
                if (doc.getTextWidth(displayText) > maxWidth) {
                    while (doc.getTextWidth(displayText + '...') > maxWidth && displayText.length > 1) {
                        displayText = displayText.slice(0, -1);
                    }
                    displayText += '...';
                }

                doc.text(displayText, this.margin + 2 + (i * colWidth), currentY + 4);
            });

            currentY += rowHeight;
        });

        // Update current Y position
        this.currentY = currentY;
    }

    // Add footer with page numbers
    addFooter() {
        const doc = this.doc;
        const pageCount = doc.internal.getNumberOfPages();

        for (let i = 1; i <= pageCount; i++) {
            doc.setPage(i);
            
            // Footer line
            doc.setDrawColor(204, 204, 204);
            doc.line(this.margin, 285, 195, 285);

            // Page number
            doc.setFontSize(8);
            doc.setTextColor(102, 102, 102);
            doc.text(`Page ${i} of ${pageCount}`, 105, 290, { align: 'center' });

            // System info
            doc.text('Generated by RFID Management System', 105, 294, { align: 'center' });
        }
    }

    // Generate and return the PDF buffer
    async generate() {
        try {
            this.addFooter();
            
            // Get PDF as blob
            const pdfBlob = this.doc.output('blob');
            
            // Convert blob to buffer for Node.js compatibility
            const arrayBuffer = await pdfBlob.arrayBuffer();
            const buffer = Buffer.from(arrayBuffer);
            
            return buffer;
        } catch (error) {
            console.error('Error generating PDF:', error);
            throw new Error('Failed to generate PDF: ' + error.message);
        }
    }

    // Static method to create access logs report
    static async createAccessLogsReport(accessLogs, options = {}) {
        try {
            const exporter = new PDFExporter('Vehicle Access Logs', options);
            
            exporter.addHeader();
            exporter.addMetadata();

            // Add summary if provided
            if (options.summary) {
                exporter.addSummary(options.summary);
            }

            // Prepare data
            const headers = ['Date/Time', 'Vehicle', 'Owner', 'Entry Type', 'Location'];
            const data = accessLogs.map(log => [
                log.timestamp ? new Date(log.timestamp).toLocaleString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Invalid Date',
                log.vehicle_info || 'Unknown Vehicle',
                log.full_name || 'Unknown Owner',
                log.access_type || log.entry_type || 'Unknown',
                log.gate_location || log.location || 'Main Gate'
            ]);

            exporter.addDataTable(headers, data, { 
                maxRows: 100
            });

            return await exporter.generate();
        } catch (error) {
            console.error('Error creating access logs PDF:', error);
            throw error;
        }
    }
}